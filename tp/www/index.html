<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <!-- Liens vers les scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<p>Votre ID unique est : <span id="uniqueId"></span></p>
<div id="connectedUsers">
    <h2>Users connected:</h2>
    <ul id="users"></ul>
</div>
<div>
    <h2>Chat :</h2>
    <ul id="messages"></ul>
</div>

<form id="refreshUsers">
    <button type="submit" id="refresh">Refresh</button>
</form>
<script>
    const emetId = Math.floor(Math.random() * 1000000);
    document.getElementById('uniqueId').innerText = emetId;
    const socket = io({
        query: {
            id: emetId
        }
    });

    document.getElementById('refreshUsers').addEventListener('submit', function(event) {
        event.preventDefault();
        socket.emit('refresh users');
    });

    socket.on('receive message', (msg) => {
        const messageItem = document.createElement('li');
        messageItem.appendChild(document.createTextNode(msg.mess));
        document.getElementById('messages').appendChild(messageItem);
    });

    socket.on('reponse', ans => {
        if (ans == ture){

        }
        else{
            const cont = document.createElement('div');
            const txt = document.createElement('p');
            txt.textContent = `Il veut pas jouer`;
            cont.appendChild(txt);
        }
    });

    socket.on('receive invitation', (msg) => {
        console.log('oui')
        const messageItem = document.createElement('li');
        const inviteMessage = `${msg.emet} demande si tu veux jouer ?`;
        messageItem.appendChild(document.createTextNode(inviteMessage));
        document.getElementById('messages').appendChild(messageItem);
        const yesButton = document.createElement('button');
        yesButton.textContent = 'Oui';
        yesButton.addEventListener('click', () => {
            socket.emit('invitation response', {answer: true, dest: msg.emet});
        });
        messageItem.appendChild(yesButton)
        const noButton = document.createElement('button');
        noButton.textContent = 'Non';
        noButton.addEventListener('click', () => {
            socket.emit('invitation response', {answer: false, dest: msg.emet});
        });
        messageItem.appendChild(noButton)
    });

    socket.on('reception users', (users) => {
        const usersList = document.getElementById('users');
        usersList.innerHTML = '';

        users.forEach((user) => {
            const listItem = document.createElement('li');
            const button = document.createElement('button');

            button.textContent = user.lastName;
            button.addEventListener('click', () => {
                const userContainer = document.createElement('div');
                userContainer.classList.add('user-container');

                const userName = document.createElement('p');
                userName.textContent = user.lastName;

                const userID = document.createElement('p');
                userID.textContent = `ID : ${user.id}`;

                const idInput = document.createElement('input');
                idInput.setAttribute('type', 'number');
                idInput.setAttribute('placeholder', 'Votre ID');

                const messageInput = document.createElement('input');
                messageInput.setAttribute('type', 'text');
                messageInput.setAttribute('placeholder', 'Votre message');

                const emptyButton = document.createElement('button');
                emptyButton.textContent = 'Inviter';
                emptyButton.addEventListener('click', () => {
                    const text = document.createElement('p');
                    text.textContent = `En attente de rÃ©ponse`;
                    userContainer.appendChild(text);
                    const userId = idInput.value;
                    socket.emit('send message', { emet: emetId, mess: null, dest: userId });
                });

                const sendButton = document.createElement('button');
                sendButton.textContent = 'Envoyer';
                sendButton.addEventListener('click', () => {
                    event.preventDefault();
                    const userMessage = messageInput.value;
                    const userId = idInput.value;
                    socket.emit('send message', { emet: emetId, mess: userMessage, dest: user.id });
                });

                userContainer.appendChild(userName);
                userContainer.appendChild(userID);
                userContainer.appendChild(idInput);
                userContainer.appendChild(emptyButton);
                userContainer.appendChild(messageInput);
                userContainer.appendChild(sendButton);

                document.body.appendChild(userContainer);
            });

            listItem.appendChild(button);
            usersList.appendChild(listItem);
        });
    });

</script>
</body>
</html>
